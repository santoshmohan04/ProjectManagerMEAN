<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>Dashboard</h1>
      <div class="header-actions">
        @if (store.lastUpdatedFormatted()) {
          <span class="last-updated">
            Last updated: {{ store.lastUpdatedFormatted() }}
          </span>
        }
        <button 
          mat-raised-button 
          color="primary" 
          (click)="refreshDashboard()"
          [disabled]="store.isLoading()">
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State with Skeleton Loaders -->
  @if (store.isLoading()) {
    <div class="dashboard-content">
      <!-- Skeleton for Project Metrics -->
      <section class="metrics-section">
        <h2>Projects Overview</h2>
        <div class="metrics-grid">
          @for (i of [1, 2, 3]; track i) {
            <mat-card class="metric-card">
              <mat-card-content>
                <app-skeleton-loader type="card" [height]="100"></app-skeleton-loader>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </section>

      <!-- Skeleton for Task Metrics -->
      <section class="metrics-section">
        <h2>Tasks Overview</h2>
        <div class="metrics-grid">
          @for (i of [1, 2, 3]; track i) {
            <mat-card class="metric-card">
              <mat-card-content>
                <app-skeleton-loader type="card" [height]="100"></app-skeleton-loader>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </section>

      <!-- Skeleton for Charts -->
      <div class="charts-row">
        <mat-card class="chart-card">
          <mat-card-content>
            <app-skeleton-loader type="rect" [height]="300"></app-skeleton-loader>
          </mat-card-content>
        </mat-card>
        <mat-card class="chart-card">
          <mat-card-content>
            <app-skeleton-loader type="rect" [height]="300"></app-skeleton-loader>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (store.hasError()) {
    <app-empty-state
      icon="error"
      [iconSize]="64"
      title="Unable to load dashboard"
      [message]="store.error() || 'An error occurred while loading dashboard data.'"
      actionLabel="Try Again"
      actionIcon="refresh"
      (actionClick)="refreshDashboard()">
    </app-empty-state>
  }

  <!-- Dashboard Content -->
  @if (store.hasData() && !store.isLoading()) {
    <div class="dashboard-content">
      <!-- Project Metrics Row -->
      <section class="metrics-section">
        <h2>Projects Overview</h2>
        <div class="metrics-grid">
          @for (metric of projectMetrics(); track metric.title) {
            <mat-card class="metric-card" [class]="'metric-' + metric.color">
              <mat-card-content>
                <div class="metric-icon">
                  <mat-icon>{{ metric.icon }}</mat-icon>
                </div>
                <div class="metric-info">
                  <div class="metric-value">{{ metric.value }}</div>
                  <div class="metric-label">{{ metric.title }}</div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </section>

      <!-- Task Metrics Row -->
      <section class="metrics-section">
        <h2>Tasks Overview</h2>
        <div class="metrics-grid">
          @for (metric of taskMetrics(); track metric.title) {
            <mat-card class="metric-card" [class]="'metric-' + metric.color">
              <mat-card-content>
                <div class="metric-icon">
                  <mat-icon>{{ metric.icon }}</mat-icon>
                </div>
                <div class="metric-info">
                  <div class="metric-value">{{ metric.value }}</div>
                  <div class="metric-label">{{ metric.title }}</div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </section>

      <!-- Charts Row -->
      <div class="charts-row">
        <!-- Task Distribution Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Task Distribution</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (taskChartBars().length > 0) {
              <div class="bar-chart">
                @for (bar of taskChartBars(); track bar.name) {
                  <div class="bar-item">
                    <div class="bar-label">{{ bar.name }}</div>
                    <div class="bar-container">
                      <div 
                        class="bar-fill" 
                        [style.width]="bar.width"
                        [style.background-color]="bar.color">
                      </div>
                      <span class="bar-value">{{ bar.value }}</span>
                    </div>
                  </div>
                }
              </div>
              
              <!-- Task Completion Rate -->
              <div class="completion-rate">
                <div class="rate-label">Task Completion Rate</div>
                <div class="rate-value">{{ store.taskCompletionRate() }}%</div>
                <div class="progress-bar">
                  <div 
                    class="progress-fill" 
                    [style.width.%]="store.taskCompletionRate()">
                  </div>
                </div>
              </div>
            } @else {
              <app-empty-state
                icon="bar_chart"
                [iconSize]="48"
                title="No task data"
                message="Task statistics will appear here once tasks are created."
              ></app-empty-state>
            }
          </mat-card-content>
        </mat-card>

        <!-- Project Status Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Project Status Distribution</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (projectChartSegments().length > 0) {
              <div class="donut-chart-container">
                <div class="donut-chart">
                  <svg viewBox="0 0 100 100">
                    <circle 
                      class="donut-hole" 
                      cx="50" 
                      cy="50" 
                      r="30">
                    </circle>
                    @for (segment of projectChartSegments(); track segment.label; let i = $index) {
                      <circle
                        class="donut-segment"
                        cx="50"
                        cy="50"
                        r="20"
                        [attr.fill]="segment.color"
                        [attr.stroke]="segment.color"
                        stroke-width="20"
                        [attr.stroke-dasharray]="segment.percentage + ' ' + (100 - segment.percentage)"
                        [attr.transform]="'rotate(' + (segment.startAngle - 90) + ' 50 50)'">
                      </circle>
                    }
                  </svg>
                  <div class="donut-center">
                    <div class="center-value">{{ store.projectStats()?.total }}</div>
                    <div class="center-label">Projects</div>
                  </div>
                </div>

                <!-- Legend -->
                <div class="chart-legend">
                  @for (segment of projectChartSegments(); track segment.label) {
                    <div class="legend-item">
                      <span 
                        class="legend-color" 
                        [style.background-color]="segment.color">
                      </span>
                      <span class="legend-label">
                        {{ segment.label }} ({{ segment.value }})
                      </span>
                    </div>
                  }
                </div>
              </div>

              <!-- Project Completion Rate -->
              <div class="completion-rate">
                <div class="rate-label">Project Completion Rate</div>
                <div class="rate-value">{{ store.projectCompletionRate() }}%</div>
                <div class="progress-bar">
                  <div 
                    class="progress-fill success" 
                    [style.width.%]="store.projectCompletionRate()">
                  </div>
                </div>
              </div>
            } @else {
              <div class="no-data">
                <mat-icon>pie_chart</mat-icon>
                <p>No project data available</p>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Recent Projects Section -->
      @if (store.recentProjects().length > 0) {
        <section class="recent-section">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>history</mat-icon>
                Recent Projects
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="projects-list">
                @for (project of store.recentProjects(); track project._id) {
                  <div class="project-item">
                    <div class="project-info">
                      <div class="project-name">{{ project.Project }}</div>
                      <div class="project-meta">
                        <mat-chip [class]="getStatusColor(project.Status)">
                          {{ project.Status }}
                        </mat-chip>
                        <mat-chip [class]="getPriorityColor(project.Priority)">
                          Priority: {{ project.Priority }}
                        </mat-chip>
                      </div>
                    </div>
                    @if (project.NoOfTasks && project.NoOfTasks > 0) {
                      <div class="project-progress">
                        <div class="progress-info">
                          <span>{{ project.CompletedTasks || 0 }} / {{ project.NoOfTasks }} tasks</span>
                          <span>{{ getProjectProgress(project.CompletedTasks, project.NoOfTasks) }}%</span>
                        </div>
                        <div class="progress-bar">
                          <div 
                            class="progress-fill" 
                            [style.width.%]="getProjectProgress(project.CompletedTasks, project.NoOfTasks)">
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        </section>
      }

      <!-- Additional Stats Row -->
      @if (store.userStats()) {
        <section class="stats-section">
          <mat-card class="stat-card">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>group</mat-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ store.userStats()?.active || 0 }}</div>
                <div class="stat-label">Active Users</div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="stat-card">
            <mat-card-content>
              <div class="stat-icon">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ store.activeTaskCount() }}</div>
                <div class="stat-label">Tasks In Progress</div>
              </div>
            </mat-card-content>
          </mat-card>

          @if (store.overdueCount() > 0) {
            <mat-card class="stat-card alert">
              <mat-card-content>
                <div class="stat-icon">
                  <mat-icon>schedule</mat-icon>
                </div>
                <div class="stat-info">
                  <div class="stat-value">{{ store.overdueCount() }}</div>
                  <div class="stat-label">Overdue Tasks</div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </section>
      }
    </div>
  }
</div>
